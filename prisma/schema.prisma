// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  shadowDatabaseUrl = env("SHADOW_DATABASE_URL")
}

enum UserStatus {
  ACTIVE
  BLOCKED
  INACTIVE
}

enum ProductStatus {
  PENDING
  APPROVED
  REJECTED
}

enum LeadStatus {
  NEW
  ASSIGNED
  CALLBACK
  CONFIRMED
  CANCELLED
}

enum OrderStatus {
  NEW
  ASSIGNED
  IN_DELIVERY
  DELIVERED
  RETURNED
  ARCHIVED
}

enum PayoutStatus {
  PENDING
  APPROVED
  REJECTED
  PAID
  CANCELLED
}

enum NotificationType {
  SYSTEM
  ORDER
  LEAD
  PAYOUT
  USER
}

enum BalanceAccountType {
  TARGETOLOG_HOLD
  TARGETOLOG_MAIN
  OPERATOR_HOLD
  OPERATOR_MAIN
  AFFILIATE_MAIN
  SELLER_MAIN
  BLOGGER_MAIN
  MANAGER_MAIN
  GENERIC_MAIN
}

enum BalanceTransactionType {
  LEAD_ACCEPTED
  LEAD_SOLD
  LEAD_CANCELLED
  PAYOUT_REQUEST
  PAYOUT_APPROVED
  PAYOUT_REJECTED
  ADMIN_ADJUSTMENT
  FRAUD_REVERSAL
}

enum FraudCheckStatus {
  OPEN
  REVIEWING
  RESOLVED
  REVOKED
}

enum TransactionType {
  HOLD_ADD
  HOLD_RELEASE
  HOLD_REMOVE
  MAIN_ADD
  MAIN_REMOVE
  PAYOUT_REQUEST
  PAYOUT_APPROVED
  PAYOUT_REJECTED
}

model User {
  id               String               @id @default(uuid())
  createdAt        DateTime             @default(now())
  updatedAt        DateTime             @updatedAt
  firstName        String
  lastName         String?
  email            String?              @unique
  nickname         String
  phone            String               @unique
  passwordHash     String
  status           UserStatus           @default(ACTIVE)
  lastLoginAt      DateTime?
  blockedAt        DateTime?
  referralCode     String?
  termsAcceptedAt  DateTime?
  emailVerifiedAt  DateTime?
  phoneVerifiedAt  DateTime?
  salesSharePercent Decimal   @default(100) @db.Decimal(5, 2)
  roleId           String
  role             Role                 @relation(fields: [roleId], references: [id], onDelete: Restrict)
  refreshTokens    RefreshToken[]
  resetTokens      PasswordResetToken[]
  products         Product[]            @relation("ProductOwner")
  flows            Flow[]               @relation("FlowOwner")
  leads            Lead[]               @relation("LeadTargetolog")
  operatorLeads    Lead[]               @relation("LeadOperator")
  ordersAsTarget   Order[]              @relation("OrderTargetolog")
  ordersAsOperator Order[]              @relation("OrderOperator")
  payouts          Payout[]
  notifications    Notification[]       @relation("NotificationRecipient")
  activityLogs     ActivityLog[]
  balanceAccounts  BalanceAccount[]
  balanceTransactions BalanceTransaction[]
  fraudChecks      BalanceFraudCheck[]
  userBalance      UserBalance?
  payoutRequests   PayoutRequest[]
  transactions     Transaction[]

  @@index([status])
}

model Role {
  id          String             @id @default(uuid())
  name        String
  slug        String             @unique
  description String?
  createdAt   DateTime           @default(now())
  updatedAt   DateTime           @updatedAt
  users       User[]
  permissions RolePermission[]
}

model Permission {
  id          String             @id @default(uuid())
  name        String
  slug        String             @unique
  description String?
  createdAt   DateTime           @default(now())
  updatedAt   DateTime           @updatedAt
  roles       RolePermission[]
}

model RolePermission {
  roleId       String
  permissionId String
  assignedAt   DateTime @default(now())

  role       Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)
  permission Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  @@id([roleId, permissionId])
}

model Product {
  id          String         @id @default(uuid())
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt
  title       String
  description String
  price       Decimal        @db.Decimal(12, 2)
  cpaTargetolog Decimal?     @db.Decimal(12, 2)
  cpaOperator  Decimal?      @db.Decimal(12, 2)
  images      String[]       @default([])
  stock       Int            @default(0)
  status      ProductStatus  @default(PENDING)
  ownerId     String
  owner       User           @relation("ProductOwner", fields: [ownerId], references: [id], onDelete: Restrict)
  flows       Flow[]
  leads       Lead[]
  orders      Order[]

  @@index([ownerId])
  @@index([status])
}

enum FlowStatus {
  ACTIVE
  PAUSED
}

model Flow {
  id        String     @id @default(uuid())
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt
  title     String
  slug      String     @unique
  url       String
  clicks    Int        @default(0)
  leads     Int        @default(0)
  orders    Int        @default(0)
  status    FlowStatus @default(ACTIVE)
  productId String
  ownerId   String
  product   Product    @relation(fields: [productId], references: [id], onDelete: Cascade)
  owner     User       @relation("FlowOwner", fields: [ownerId], references: [id], onDelete: Cascade)
  leadRecords Lead[]

  @@index([productId])
  @@index([ownerId])
  @@index([status])
}

model BalanceAccount {
  id        String              @id @default(uuid())
  createdAt DateTime            @default(now())
  updatedAt DateTime            @updatedAt
  userId    String
  type      BalanceAccountType
  amount    Decimal             @default(0) @db.Decimal(18, 2)
  currency  String              @default("UZS")
  user      User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  transactions BalanceTransaction[]

  @@unique([userId, type])
  @@index([userId])
}

model BalanceTransaction {
  id             String                  @id @default(uuid())
  createdAt      DateTime                @default(now())
  accountId      String
  userId         String
  type           BalanceTransactionType
  amount         Decimal                 @db.Decimal(18, 2)
  balanceBefore  Decimal                 @db.Decimal(18, 2)
  balanceAfter   Decimal                 @db.Decimal(18, 2)
  isCredit       Boolean
  note           String?
  metadata       Json?
  leadId         String?
  payoutId       String?
  account        BalanceAccount          @relation(fields: [accountId], references: [id], onDelete: Cascade)
  user           User                    @relation(fields: [userId], references: [id], onDelete: Cascade)
  lead           Lead?                   @relation(fields: [leadId], references: [id], onDelete: SetNull)
  payout         Payout?                 @relation(fields: [payoutId], references: [id], onDelete: SetNull)
  fraudFlags     BalanceFraudCheck[]

  @@index([accountId])
  @@index([userId])
  @@index([leadId])
  @@index([payoutId])
}

model BalanceFraudCheck {
  id             String             @id @default(uuid())
  createdAt      DateTime           @default(now())
  resolvedAt     DateTime?
  userId         String
  transactionId  String?
  status         FraudCheckStatus   @default(OPEN)
  reason         String
  resolutionNote String?
  metadata       Json?
  user           User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  transaction    BalanceTransaction? @relation(fields: [transactionId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([transactionId])
}

model UserBalance {
  id          String   @id @default(cuid())
  userId      String   @unique
  holdBalance Decimal  @default("0.00") @db.Decimal(12,2)
  mainBalance Decimal  @default("0.00") @db.Decimal(12,2)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user User @relation(fields: [userId], references: [id])
}

model PayoutRequest {
  id         String        @id @default(cuid())
  userId     String
  amount     Decimal       @db.Decimal(12,2)
  cardNumber String
  cardHolder String
  comment    String?
  status     PayoutStatus  @default(PENDING)
  createdAt  DateTime      @default(now())
  updatedAt  DateTime      @updatedAt

  user User @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([status])
}

model Transaction {
  id        String           @id @default(cuid())
  userId    String
  type      TransactionType
  amount    Decimal          @db.Decimal(12,2)
  meta      Json?
  createdAt DateTime         @default(now())

  user User @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([type])
}

model Lead {
  id               String      @id @default(uuid())
  createdAt        DateTime    @default(now())
  updatedAt        DateTime    @updatedAt
  flowId           String
  productId        String
  targetologId     String
  operatorId       String?
  phone            String
  name             String?
  status           LeadStatus  @default(NEW)
  notes            String?
  flow             Flow        @relation(fields: [flowId], references: [id], onDelete: Cascade)
  product          Product     @relation(fields: [productId], references: [id], onDelete: Cascade)
  targetolog       User        @relation("LeadTargetolog", fields: [targetologId], references: [id], onDelete: Cascade)
  operator         User?       @relation("LeadOperator", fields: [operatorId], references: [id], onDelete: SetNull)
  orders           Order[]
  balanceTransactions BalanceTransaction[]

  @@index([targetologId])
  @@index([operatorId])
  @@index([productId])
  @@index([status])
}

model Order {
  id            String       @id @default(uuid())
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt
  productId     String
  targetologId  String
  operatorId    String?
  leadId        String?
  status        OrderStatus  @default(NEW)
  amount        Decimal      @db.Decimal(12, 2)
  product       Product      @relation(fields: [productId], references: [id], onDelete: Restrict)
  targetolog    User         @relation("OrderTargetolog", fields: [targetologId], references: [id], onDelete: Restrict)
  operator      User?        @relation("OrderOperator", fields: [operatorId], references: [id], onDelete: SetNull)
  lead          Lead?        @relation(fields: [leadId], references: [id], onDelete: SetNull)

  @@index([productId])
  @@index([targetologId])
  @@index([operatorId])
  @@index([status])
}

model Payout {
  id        String        @id @default(uuid())
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt
  userId    String
  amount    Decimal       @db.Decimal(12, 2)
  status    PayoutStatus  @default(PENDING)
  comment   String?
  cardNumber String?
  cardHolder String?
  user      User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  balanceTransactions BalanceTransaction[]

  @@index([userId])
  @@index([status])
}

model Notification {
  id        String           @id @default(uuid())
  createdAt DateTime         @default(now())
  updatedAt DateTime         @updatedAt
  toUserId  String
  message   String
  seen      Boolean          @default(false)
  type      NotificationType @default(SYSTEM)
  metadata  Json?
  recipient User             @relation("NotificationRecipient", fields: [toUserId], references: [id], onDelete: Cascade)

  @@index([toUserId])
  @@index([seen])
  @@index([type])
}

model ActivityLog {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now())
  userId    String
  action    String
  ip        String?
  device    String?
  meta      Json?
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([createdAt])
}

model RefreshToken {
  id         String   @id @default(uuid())
  tokenHash  String
  userId     String
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt  DateTime @default(now())
  expiresAt  DateTime
  revokedAt  DateTime?

  @@index([tokenHash])
}

model PasswordResetToken {
  id         String   @id @default(uuid())
  tokenHash  String   @unique
  userId     String
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt  DateTime @default(now())
  expiresAt  DateTime
  usedAt     DateTime?

  @@index([expiresAt])
}
